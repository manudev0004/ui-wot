<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Minimal All-Components TD Demo</title>
    <style>
      body {
        font-family: system-ui, -apple-system, sans-serif;
        max-width: 900px;
        margin: 28px auto;
        padding: 18px;
        background: #f8fafc;
      }
      .card {
        background: #fff;
        padding: 16px;
        border-radius: 10px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
      }
      .row {
        display: flex;
        gap: 14px;
        align-items: center;
        margin: 14px 0;
      }
      h1 {
        margin: 0 0 12px;
      }
      .meta {
        color: #6b7280;
        font-size: 12px;
      }
    </style>
  </head>
  <body>
    <div class="card">
      <h1>Clean TD Demo with Component Methods</h1>


      <div class="row">
        <div>
          <h3>Toggle (bool)</h3>
          <ui-toggle
            id="td-toggle"
            label="TD Toggle"
            variant="neon"
            show-last-updated="true"
            show-status="true"
          ></ui-toggle>
        </div>
      </div>

      <div class="row">
        <div>
          <h3>Slider (num)</h3>
          <ui-slider
            id="td-slider"
            min="0"
            max="100"
            label="TD Slider"
            orientation="horizontal"
            show-last-updated="true"
            show-status="true"
          ></ui-slider>
        </div>
      </div>

      <div class="row">
        <div>
          <h3>Number Picker (int)</h3>
          <ui-number-picker
            id="td-number"
            min="0"
            max="100"
            label="TD Number"
            show-last-updated="true"
            show-status="true"
          ></ui-number-picker>
        </div>
      </div>

      <div class="row">
        <div>
          <h3>Button</h3>
          <ui-button 
            id="td-button" 
            label="TD Button" 
            show-last-updated="true" 
            show-status="true"
          ></ui-button>
        </div>
      </div>

      <div class="row">
        <div>
          <h3>Checkbox (bool)</h3>
          <ui-checkbox
            id="td-checkbox"
            label="TD Checkbox"
            show-last-updated="true"
            show-status="true"
          ></ui-checkbox>
        </div>
      </div>

      <div class="row">
        <div>
          <h3>Calendar with Time Picker</h3>
          <ui-calendar
            id="td-calendar"
            label="Date & Time Picker"
            show-last-updated="true"
            variant="outlined"
            color="primary"
            value="2025-09-08T10:30:00Z"
            include-time="true"
            time-format="12"
          ></ui-calendar>
        </div>
      </div>

      <div class="row">
        <div>
          <h3>Notification</h3>
          <ui-notification
            id="td-notification"
            message="Connected to Thing"
            type="success"
            show-last-updated="true"
            duration="0"
          ></ui-notification>
        </div>
      </div>

      <div class="row">
        <div>
          <h3>Text Display - Different Modes & Variants</h3>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
            <!-- Field Mode -->
            <ui-text
              id="td-text-field"
              mode="field"
              variant="outlined"
              value="Single line text field"
              label="Field Mode (outlined)"
            ></ui-text>
            
            <ui-text
              id="td-text-field-filled"
              mode="field"
              variant="filled"
              value="Single line text field"
              label="Field Mode (filled)"
            ></ui-text>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
            <!-- Area Mode -->
            <ui-text
              id="td-text-area"
              mode="area"
              variant="outlined"
              value="Multi-line text area Line 2 of content Line 3 of content Line 4 with more text"
              label="Area Mode (outlined)"
              min-rows="3"
              max-rows="6"
              show-line-numbers="true"
            ></ui-text>
            
            <ui-text
              id="td-text-area-filled"
              mode="area"
              variant="filled"
              value="Multi-line text area&#10;Line 2 of content&#10;Line 3 of content&#10;Line 4 with more text"
              label="Area Mode (filled)"
              min-rows="3"
              max-rows="6"
            ></ui-text>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
            <!-- Structured Mode -->
            <ui-text
              id="td-text-structured"
              mode="structured"
              variant="outlined"
              value='{"temperature": 23.5, "humidity": 45, "status": "online", "lastUpdate": "2025-09-08T10:30:00Z"}'
              label="Structured Mode (JSON with line numbers)"
              show-line-numbers="true"
            ></ui-text>
            
            <ui-text
              id="td-text-unstructured"
              mode="unstructured"
              variant="minimal"
              value="Plain unstructured text with no special formatting or highlighting applied to the content."
              label="Unstructured Mode (minimal)"
            ></ui-text>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
            <!-- Editable Mode -->
            <ui-text
              id="td-text-editable"
              mode="editable"
              variant="outlined"
              value="Edit this text content"
              label="Editable Mode"
              show-char-count="true"
              max-length="100"
            ></ui-text>
            
            <!-- TD Connected Text -->
            <ui-text
              id="td-text"
              mode="editable"
              variant="filled"              
              debounce-ms="1000"
              value="Thing Description Data"
              label="TD Connected (string property)"
              show-last-updated="true"
              show-status="true"
            
            ></ui-text>
          </div>
        </div>
      </div>

      <div class="row">
        <div>
          <h3>Event Listener/Publisher</h3>
          <div>
            <ui-event
              id="td-event-listener"
              label="Temperature Events"
              mode="listener"
              event-name="temperatureChanged"
              max-events="5"
              show-timestamp="true"
              show-last-updated="true"
            ></ui-event>
          </div>
          <div style="margin-top: 12px;">
            <ui-event
              id="td-event-publisher"
              label="Alert Publisher"
              mode="publisher"
              event-name="alertTriggered"
              auto-publish="false"
              variant="filled"
              color="primary"
            ></ui-event>
          </div>
        </div>
      </div>


      <div class="meta">Open the browser console to see events and status messages.</div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@node-wot/browser-bundle@latest/dist/wot-bundle.min.js"></script>
    <script type="module" src="./build/ui-wot-components.esm.js"></script>

    <script>
      // TD handling with Node-WoT
      (async function () {
        
        
        // Wait for all components to be defined
        const COMPONENT_TAGS = ['ui-toggle', 'ui-slider', 'ui-number-picker', 'ui-button', 'ui-checkbox', 'ui-calendar', 'ui-notification', 'ui-text', 'ui-event'];
        await Promise.all(COMPONENT_TAGS.map(tag => customElements.whenDefined(tag)));
        console.log('Components ready');

        // Initialize WoT
        if (!window.WoT) {
          console.error('WoT library not loaded');
          return;
        }

        // Create WoT runtime
        const servient = new window.WoT.Core.Servient();
        servient.addClientFactory(new window.WoT.Http.HttpClientFactory());
        const wot = await servient.start();
        console.log('WoT servient started');

        // Fetch and consume Thing Description
        const tdUrl = 'http://localhost:8080/testthing';
        // const tdUrl = 'http://plugfest.thingweb.io/http-data-schema-thing';
        let thing;
        let serverHealth = 'unknown';
        
        try {
            console.log('Fetching TD from:', tdUrl);
          const response = await fetch(tdUrl);
          const tdJson = await response.json();
          thing = await wot.consume(tdJson);
          console.log('TD consumed successfully');
          console.log('Available properties:', Object.keys(tdJson.properties || {}));
          
          // Test server health by trying a simple read
          try {
            await thing.readProperty('bool');
            serverHealth = 'healthy';
            console.log('Server health check passed');
          } catch (healthErr) {
            serverHealth = 'read-only';
            console.warn('Server allows TD fetch but read failed:', healthErr.message);
          }
        } catch (error) {
          console.error('Failed to fetch/consume TD:', error);
          // Show user-friendly error message
          document.body.insertAdjacentHTML('beforeend', `
            <div style="background: #fee; border: 1px solid #fcc; border-radius: 8px; padding: 16px; margin: 16px auto; max-width: 900px; color: #c33;">
              <strong>Demo Server Unavailable</strong><br>
              The WoT demo server at plugfest.thingweb.io is currently unavailable. 
              Components are still functional - you can interact with them to see the UI behavior.
            </div>
          `);
          return;
        }

        // --- Component TD Integration Pattern ---------------------------------
        // This demo shows the new unified pattern for connecting UI components to
        // Thing Description (TD) properties using the new setValue method:
        // 1) Wait for component to be ready (componentOnReady)
        // 2) Read initial value from TD and call setValue(value, { writeOperation })
        // 3) Components automatically handle user interactions and call writeOperation
        // ----------------------------------------------------------------

        // Toggle component - connects to TD bool property
        const toggleElement = document.getElementById('td-toggle');
        if (toggleElement && thing) {
          await toggleElement.componentOnReady();
          
          try {
            const initialValue = Boolean(await (await thing.readProperty('bool')).value());
            await toggleElement.setValue(initialValue, {
              writeOperation: async (value) => {
                console.log('Writing toggle value:', value, 'to bool property');
                await thing.writeProperty('bool', value);
                console.log('Toggle write successful');
              }
            });
            console.log('Toggle connected to bool property, initial value:', initialValue);
          } catch (error) {
            console.error('Toggle connection failed:', error);
            await toggleElement.setValue(false);
            await toggleElement.setStatus('error', 'Connection failed');
          }
        }

        // Number picker component - connects to TD int property  
        const numberElement = document.getElementById('td-number');
        if (numberElement && thing) {
          await numberElement.componentOnReady();
          
          try {
            const initialValue = Number(await (await thing.readProperty('int')).value());
            await numberElement.setValue(initialValue, {
              writeOperation: async (value) => {
                console.log('Writing number value:', value, 'to int property');
                await thing.writeProperty('int', value);
                console.log('Number picker write successful');
              }
            });
            console.log('Number picker connected to int property, initial value:', initialValue);
          } catch (error) {
            console.error('Number picker connection failed:', error);
            await numberElement.setValue(0);
            await numberElement.setStatus('error', 'Connection failed');
          }
        }

        // Button component - connects to TD action instead of property
        const buttonElement = document.getElementById('td-button');
        if (buttonElement && thing) {
          await buttonElement.componentOnReady();
          
          await buttonElement.setAction(async () => {
            console.log('Invoking void-void action');
            await thing.invokeAction('void-void');
            console.log('Action invoked successfully');
          });
          
          console.log('Button connected to void-void action');
        }

        // Define remaining component bindings for other components
        const otherBindings = [
          { element: document.getElementById('td-slider'), property: 'num' },
          { element: document.getElementById('td-checkbox'), property: 'bool' },
          { element: document.getElementById('td-text'), property: 'string' }
        ].filter(b => b.element);

        // Define standalone components - these are display-only without TD binding
        const standaloneComponents = [
          document.getElementById('td-calendar'),
          document.getElementById('td-notification'),
          document.getElementById('td-text-field'),
          document.getElementById('td-text-field-filled'),
          document.getElementById('td-text-area'),
          document.getElementById('td-text-area-filled'),
          document.getElementById('td-text-structured'),
          document.getElementById('td-text-unstructured'),
          document.getElementById('td-text-editable')
        ].filter(el => el);

        // Initialize standalone components (display-only)
        for (const element of standaloneComponents) {
          if (element && typeof element.componentOnReady === 'function') {
            await element.componentOnReady();
          }
        }
        
        console.log('Standalone components ready:', standaloneComponents.length);
        console.log('Property bindings:', otherBindings.length);

        // Show server status info
        if (serverHealth === 'read-only') {
          document.body.insertAdjacentHTML('beforeend', `
            <div style="background: #fef9e7; border: 1px solid #f7dc6f; border-radius: 8px; padding: 16px; margin: 16px auto; max-width: 900px; color: #b7950b;">
              <strong>Server Write Issues</strong><br>
              The demo server appears to have issues with write operations. You may see errors when changing values, but the components are working correctly.
            </div>
          `);
        } else if (serverHealth === 'healthy') {
          console.log('Server is healthy for read/write operations');
        }

        // Setup TD property bindings - read initial values and setup write operations
        for (const binding of otherBindings) {
          // Wait for component to be ready
          if (binding.element && typeof binding.element.componentOnReady === 'function') {
            await binding.element.componentOnReady();
          }

          try {
            // Read initial property value with timeout
            const readPromise = thing.readProperty(binding.property);
            const timeoutPromise = new Promise((_, reject) => 
              setTimeout(() => reject(new Error('Read operation timed out')), 3000)
            );
            
            const propertyValue = await Promise.race([readPromise, timeoutPromise]);
            let value = await propertyValue.value();
            
            // Handle text component - convert non-string values to strings
            if (binding.element.id === 'td-text' && typeof value !== 'string') {
              value = String(value);
            }
            
            // Setup component with value and write operation
            if (typeof binding.element.setValue === 'function') {
              await binding.element.setValue(value, {
                writeOperation: async (newValue) => {
                  console.log('Writing', newValue, 'to', binding.property);
                  
                  // Write to Thing Description property with timeout
                  const writePromise = thing.writeProperty(binding.property, newValue);
                  const timeoutPromise = new Promise((_, reject) => 
                    setTimeout(() => reject(new Error('Write operation timed out')), 5000)
                  );
                  
                  await Promise.race([writePromise, timeoutPromise]);
                  console.log('Wrote', binding.property + ':', newValue);
                }
              });
            }
            if (typeof binding.element.setStatus === 'function') {
              await binding.element.setStatus('success');
            }
            console.log('Initial', binding.property + ':', value);
          } catch (e) {
            console.error('Read failed', binding.property + ':', e.message || e);
            
            // Set default value and error status when read fails
            let defaultValue;
            if (binding.property === 'bool') {
              defaultValue = false;
            } else if (binding.property === 'num' || binding.property === 'int') {
              defaultValue = 0;
            } else {
              defaultValue = `Demo (${binding.property})`;
            }
            
            if (typeof binding.element.setValue === 'function') {
              await binding.element.setValue(defaultValue);
            }
            if (typeof binding.element.setStatus === 'function') {
              await binding.element.setStatus('error', 'Server read failed');
            }
          }
        }
      })();
    </script>
  </body>
</html>
