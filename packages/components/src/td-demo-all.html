<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Minimal All-Components TD Demo</title>
    <style>
      body {
        font-family: system-ui, -apple-system, sans-serif;
        max-width: 900px;
        margin: 28px auto;
        padding: 18px;
        background: #f8fafc;
      }
      .card {
        background: #fff;
        padding: 16px;
        border-radius: 10px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
      }
      .row {
        display: flex;
        gap: 14px;
        align-items: center;
        margin: 14px 0;
      }
      h1 {
        margin: 0 0 12px;
      }
      .meta {
        color: #6b7280;
        font-size: 12px;
      }
    </style>
  </head>
  <body>
    <div class="card">
      <h1>Clean TD Demo with Component Methods</h1>


      <div class="row">
        <div>
          <h3>Toggle (bool)</h3>
          <ui-toggle
            id="td-toggle"
            label="TD Toggle"
            variant="neon"
            show-last-updated="true"
            show-status="true"
          ></ui-toggle>
        </div>
      </div>

      <div class="row">
        <div>
          <h3>Slider (num)</h3>
          <ui-slider
            id="td-slider"
            min="0"
            max="100"
            label="TD Slider"
            orientation="horizontal"
            show-last-updated="true"
            show-status="true"
          ></ui-slider>
        </div>
      </div>

      <div class="row">
        <div>
          <h3>Number Picker (int)</h3>
          <ui-number-picker
            id="td-number"
            min="0"
            max="100"
            label="TD Number"
            show-last-updated="true"
            show-status="true"
          ></ui-number-picker>
        </div>
      </div>

      <div class="row">
        <div>
          <h3>Button</h3>
          <ui-button 
            id="td-button" 
            label="TD Button" 
            show-last-updated="true" 
            show-status="true"
          ></ui-button>
        </div>
      </div>

      <div class="row">
        <div>
          <h3>Checkbox (bool)</h3>
          <ui-checkbox
            id="td-checkbox"
            label="TD Checkbox"
            show-last-updated="true"
            show-status="true"
          ></ui-checkbox>
        </div>
      </div>

      <div class="row">
        <div>
          <h3>Calendar (standalone demo)</h3>
          <ui-calendar
            id="td-calendar"
            label="Date Picker"
            show-last-updated="true"
            variant="outlined"
            color="primary"
            value="2025-09-08"
          ></ui-calendar>
        </div>
      </div>

      <div class="row">
        <div>
          <h3>Notification</h3>
          <ui-notification
            id="td-notification"
            message="Connected to Thing"
            type="success"
            show-last-updated="true"
            duration="0"
          ></ui-notification>
        </div>
      </div>

      <div class="row">
        <div>
          <h3>Text Display - Different Modes & Variants</h3>
          
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
            <!-- Field Mode -->
            <ui-text
              id="td-text-field"
              mode="field"
              variant="outlined"
              value="Single line text field"
              label="Field Mode (outlined)"
            ></ui-text>
            
            <ui-text
              id="td-text-field-filled"
              mode="field"
              variant="filled"
              value="Single line text field"
              label="Field Mode (filled)"
            ></ui-text>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
            <!-- Area Mode -->
            <ui-text
              id="td-text-area"
              mode="area"
              variant="outlined"
              value="Multi-line text area&#10;Line 2 of content&#10;Line 3 of content&#10;Line 4 with more text"
              label="Area Mode (outlined)"
              min-rows="3"
              max-rows="6"
              show-line-numbers="true"
            ></ui-text>
            
            <ui-text
              id="td-text-area-filled"
              mode="area"
              variant="filled"
              value="Multi-line text area&#10;Line 2 of content&#10;Line 3 of content&#10;Line 4 with more text"
              label="Area Mode (filled)"
              min-rows="3"
              max-rows="6"
            ></ui-text>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
            <!-- Structured Mode -->
            <ui-text
              id="td-text-structured"
              mode="structured"
              variant="outlined"
              value='{"temperature": 23.5, "humidity": 45, "status": "online", "lastUpdate": "2025-09-08T10:30:00Z"}'
              label="Structured Mode (JSON with line numbers)"
              show-line-numbers="true"
            ></ui-text>
            
            <ui-text
              id="td-text-unstructured"
              mode="unstructured"
              variant="minimal"
              value="Plain unstructured text with no special formatting or highlighting applied to the content."
              label="Unstructured Mode (minimal)"
            ></ui-text>
          </div>

          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
            <!-- Editable Mode -->
            <ui-text
              id="td-text-editable"
              mode="editable"
              variant="outlined"
              value="Edit this text content"
              label="Editable Mode"
              show-char-count="true"
              max-length="100"
            ></ui-text>
            
            <!-- TD Connected Text -->
            <ui-text
              id="td-text"
              mode="structured"
              variant="filled"
              value="Thing Description Data"
              label="TD Connected (string property)"
              show-last-updated="true"
              readonly="true"
            ></ui-text>
          </div>
        </div>
      </div>

      <div class="row">
        <div>
          <h3>Event Listener/Publisher</h3>
          <div>
            <ui-event
              id="td-event-listener"
              label="Temperature Events"
              mode="listener"
              event-name="temperatureChanged"
              max-events="5"
              show-timestamp="true"
              show-last-updated="true"
            ></ui-event>
          </div>
          <div style="margin-top: 12px;">
            <ui-event
              id="td-event-publisher"
              label="Alert Publisher"
              mode="publisher"
              event-name="alertTriggered"
              auto-publish="false"
              variant="filled"
              color="primary"
            ></ui-event>
          </div>
        </div>
      </div>


      <div class="meta">Open the browser console to see events and status messages.</div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@node-wot/browser-bundle@latest/dist/wot-bundle.min.js"></script>
    <script type="module" src="./build/ui-wot-components.esm.js"></script>

    <script>
      // TD handling with Node-WoT
      (async function () {
        
        
        // Wait for all components to be defined
        const COMPONENT_TAGS = ['ui-toggle', 'ui-slider', 'ui-number-picker', 'ui-button', 'ui-checkbox', 'ui-calendar', 'ui-notification', 'ui-text', 'ui-event'];
        await Promise.all(COMPONENT_TAGS.map(tag => customElements.whenDefined(tag)));
        console.log('All components ready');

        // Initialize WoT with timeout
        if (!window.WoT) {
          console.error('WoT library not loaded');
          return;
        }

        // Create WoT runtime
        const servient = new window.WoT.Core.Servient();
        servient.addClientFactory(new window.WoT.Http.HttpClientFactory());
        const wot = await servient.start();
  console.log('WoT Servient started');

        // Fetch and consume TD
        const tdUrl = 'http://plugfest.thingweb.io/http-data-schema-thing';
        let thing;
        try {
            console.log('Fetching TD from:', tdUrl);
          const response = await fetch(tdUrl);
          const tdJson = await response.json();
          thing = await wot.consume(tdJson);
          console.log('TD consumed successfully');
          console.log('Available properties:', Object.keys(tdJson.properties || {}));
        } catch (error) {
          console.error('Failed to fetch/consume TD:', error);
          return;
        }

        // --- Simplified demo binding ---------------------------------
        // This demo shows the minimal pattern to bind a UI component to
        // a Thing Description (TD) property. It does three things:
        // 1) Waits for the component to be ready
        // 2) Reads the current value from the Thing and calls component.setValue(value)
        // 3) Listens for the component's `valueMsg` events and writes back to the Thing
        // ----------------------------------------------------------------

        const bindings = [
          { element: document.getElementById('td-toggle'), property: 'bool' },
          { element: document.getElementById('td-slider'), property: 'num' },
          { element: document.getElementById('td-number'), property: 'int' },
          { element: document.getElementById('td-checkbox'), property: 'bool' },
          { element: document.getElementById('td-text'), property: 'string' }
        ].filter(b => b.element);

        // Special handling for non-TD components (display only, no binding)
        const standaloneComponents = [
          document.getElementById('td-calendar'),
          document.getElementById('td-notification'),
          document.getElementById('td-text-field'),
          document.getElementById('td-text-field-filled'),
          document.getElementById('td-text-area'),
          document.getElementById('td-text-area-filled'),
          document.getElementById('td-text-structured'),
          document.getElementById('td-text-unstructured'),
          document.getElementById('td-text-editable')
        ].filter(el => el);

        // Initialize standalone components
        for (const element of standaloneComponents) {
          if (element && typeof element.componentOnReady === 'function') {
            await element.componentOnReady();
          }
        }
        console.log(`Standalone components ready: ${standaloneComponents.length}`);

        console.log(`Bindings: ${bindings.length}`);

        // Initial read and simple binding setup
        for (const binding of bindings) {
          // Ensure the Stencil component is ready
          if (binding.element && typeof binding.element.componentOnReady === 'function') {
            await binding.element.componentOnReady();
          }

          try {
            // Read the property once and set the component's value
            const propertyValue = await thing.readProperty(binding.property);
            let value = await propertyValue.value();
            
            // Special handling for different component types
            if (binding.element.id === 'td-text' && typeof value !== 'string') {
              // Convert non-string values to string representation
              value = String(value);
            }
            
            // Call the component's public method so it updates its UI/state
            if (typeof binding.element.setValue === 'function') {
              await binding.element.setValue(value);
            }
            if (typeof binding.element.setStatus === 'function') {
              await binding.element.setStatus('success');
            }
            console.log(`Initial ${binding.property}:`, value);
          } catch (e) {
            console.error(`Read failed ${binding.property}:`, e.message || e);
            if (typeof binding.element.setStatus === 'function') {
              await binding.element.setStatus('error', e.message || String(e));
            }
          }

          // Write-back: when the component emits a valueMsg, write to the Thing
          binding.element.addEventListener('valueMsg', async (ev) => {
            let newValue = ev.detail && (ev.detail.payload ?? ev.detail);
            
            try {
              if (typeof binding.element.setStatus === 'function') {
                await binding.element.setStatus('loading');
              }
              await thing.writeProperty(binding.property, newValue);
              if (typeof binding.element.setStatus === 'function') {
                await binding.element.setStatus('success');
              }
              console.log(`Wrote ${binding.property}:`, newValue);
            } catch (err) {
              console.error(`Write failed ${binding.property}:`, err.message || err);
              if (typeof binding.element.setStatus === 'function') {
                await binding.element.setStatus('error', err.message || String(err));
              }
            }
          });
        }
      })();
    </script>
  </body>
</html>
