<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>ui-toggle</title>
    <style>
      body {
        font-family: system-ui, -apple-system, sans-serif;
        max-width: 780px;
        margin: 32px auto;
        padding: 16px;
        background: #f8fafc;
      }
      .card {
        background: #fff;
        padding: 18px 20px;
        border-radius: 10px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
      }
      .row {
        display: flex;
        gap: 14px;
        align-items: center;
        margin: 12px 0;
      }
      .meta {
        color: #6b7280;
        font-size: 12px;
      }
    </style>
  </head>
  <body>
    <div class="card">
      <h1>UI-Toggle Demo</h1>

      <div class="row">
        <div>
          <h3>Controller (Read/Write)</h3>
          <ui-toggle id="readwrite-toggle" label="WoT Device" show-last-updated show-status></ui-toggle>  
        </div>         
      </div>

      <div class="row">
        <div>
          <h3>Monitor (read-only)</h3>
          <ui-toggle id="readonly-toggle" readonly="true" variant="square" label="Device Monitor" show-last-updated></ui-toggle>         
        </div>
      </div>

      <div class="row">
        <div>
          <h3>Error Simulation</h3>
          <ui-toggle id="error-toggle" label="Error Demo" variant="neon" show-status></ui-toggle>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@node-wot/browser-bundle@latest/dist/wot-bundle.min.js"></script>
    <script type="module" src="./build/ui-wot-components.esm.js"></script>

    <script>
      document.addEventListener('DOMContentLoaded', async () => {
        await customElements.whenDefined('ui-toggle');

        // Get components by ids
        const writeToggle = document.getElementById('readwrite-toggle');
        const readToggle = document.getElementById('readonly-toggle');
        const errorToggle = document.getElementById('error-toggle');

        // Setup WoT connection for real device interaction
        try {
          while (!window.WoT) await new Promise(r => setTimeout(r, 100));
          const servient = new window.WoT.Core.Servient();
          servient.addClientFactory(new window.WoT.Http.HttpClientFactory());
          const wot = await servient.start();
          const td = await (await fetch('http://plugfest.thingweb.io/http-data-schema-thing')).json();
          const thing = await wot.consume(td);

          // data-schema-things bool property
          const initialValue = Boolean(await (await thing.readProperty('bool')).value());
          await writeToggle.setValue(initialValue, {
            writeOperation: async value => {
              console.log(`Writing ${value} to real device...`);
              await thing.writeProperty('bool', value);
              console.log(`Wrote : ${value}`);
            },
          });

          // Read Only with polling and pulse effect
          setInterval(async () => {
            try {
              const currentValue = Boolean(await (await thing.readProperty('bool')).value());
              await readToggle.setValueSilent(currentValue); // Use silent update to avoid triggering writeOperation
              await readToggle.triggerReadPulse(); // Visual pulse effect on update
            } catch (e) {
              console.log('Polling failed:', e.message);
              readToggle.connected = false;
            }
          }, 10000); // Poll every 10s
        } catch (err) {
          console.error('WoT setup failed:', err);
          await writeToggle.setStatus('error', 'Device connection failed');
          await readToggle.setStatus('error', 'Device connection failed');
        }

        // Error DEMO
        await errorToggle.setValue(false, {
          writeOperation: async value => {
            console.log(`Attempting to set error demo to ${value}...`);
            await new Promise(r => setTimeout(r, 1000)); // Simulate network delay to show loading state
            throw new Error(`Simulated failure when setting to ${value}`);
          },
        });
      });
    </script>
  </body>
</html>
