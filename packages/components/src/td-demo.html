<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>ui-toggle</title>
    <style>
      body {font-family: system-ui,-apple-system,sans-serif;max-width:780px;margin:32px auto;padding:16px;background:#f8fafc;}
      .card {background:#fff;padding:18px 20px;border-radius:10px;box-shadow:0 1px 3px rgba(0,0,0,.06)}
      .row {display:flex;gap:14px;align-items:center;margin:12px 0}
      .meta {color:#6b7280;font-size:12px}
    </style>
  </head>
  <body>
    <div class="card">
      <h1>ui-toggle TD demo (simplified)</h1>
      <p class="meta">Simple TD integration without legacy mode prop</p>

      <div class="row">
        <div>
          <h3>Controller (readwrite)</h3>
          <ui-toggle
            id="readwrite-toggle"
            td-property="bool"
            td-url="http://plugfest.thingweb.io/http-data-schema-thing"
            sync-interval="3000"
            label="Controller"
          ></ui-toggle>
        </div>
        <div class="meta">Property: <strong>bool</strong></div>
      </div>

      <div class="row">
        <div>
          <h3>Monitor (read-only)</h3>
          <ui-toggle id="readonly-toggle" readonly="true" sync-interval="3000" variant="square" label="Monitor"></ui-toggle>
        </div>
        <div class="meta">Property: <strong>bool</strong></div>
      </div>

      <hr style="margin: 20px 0; border: none; border-top: 1px solid #e5e7eb;">

      <div class="row">
        <div>
          <h3>Error Test (fake URL)</h3>
          <ui-toggle
            id="error-toggle"
            td-property="bool"
            td-url="http://fake-url-that-does-not-exist.com/td"
            label="Error Demo"
            variant="neon"
          ></ui-toggle>
        </div>
        <div class="meta">Should show red error badge</div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@node-wot/browser-bundle@latest/dist/wot-bundle.min.js"></script>
    <script type="module" src="./build/ui-wot-components.esm.js"></script>

    <script>
      document.addEventListener('DOMContentLoaded', async () => {
        // Get components
        const workingToggle = document.getElementById('readwrite-toggle');
        const monitorToggle = document.getElementById('readonly-toggle');
        const errorToggle = document.getElementById('error-toggle');

        await customElements.whenDefined('ui-toggle');

        // Setup working toggles
        setupToggle(workingToggle, monitorToggle);
        
        // Setup error toggle 
        setupErrorToggle(errorToggle);
      });

      async function setupToggle(writeToggle, readToggle) {
        const tdUrl = writeToggle.getAttribute('td-url');
        const propName = writeToggle.getAttribute('td-property');
        
        // Show loading
        writeToggle.startWriteOperation();
        readToggle.startWriteOperation();

        try {
          // Wait for WoT and setup servient
          while (!window.WoT) await new Promise(r => setTimeout(r, 100));
          const servient = new window.WoT.Core.Servient();
          servient.addClientFactory(new window.WoT.Http.HttpClientFactory());
          const wot = await servient.start();

          // Consume thing
          const td = await (await fetch(tdUrl)).json();
          const thing = await wot.consume(td);

          // Success - clear loading
          writeToggle.finishWriteOperation(true);
          readToggle.finishWriteOperation(true);

          // Read initial value
          const initial = Boolean(await (await thing.readProperty(propName)).value());
          writeToggle.value = readToggle.value = initial;
          readToggle.markReadUpdate();

          // Poll for changes every 3 seconds
          setInterval(async () => {
            try {
              const current = Boolean(await (await thing.readProperty(propName)).value());
              writeToggle.value = readToggle.value = current;
              readToggle.markReadUpdate();
            } catch (e) {
              writeToggle.connected = readToggle.connected = false;
            }
          }, 3000);

          // Handle writes with proper error state management
          writeToggle.addEventListener('valueMsg', async e => {
            const previousValue = !e.detail.payload; // Store for revert
            writeToggle.clearErrorState(); // Clear error state before attempting
            writeToggle.startWriteOperation();
            try {
              await thing.writeProperty(propName, e.detail.payload);
              writeToggle.finishWriteOperation(true);
              readToggle.value = e.detail.payload;
              readToggle.markReadUpdate();
            } catch (err) {
              writeToggle.finishWriteOperation(false, 'Write failed');
              writeToggle.revertValue(previousValue); // Revert to previous state
              writeToggle.connected = false; // Maintain error state
            }
          });

        } catch (err) {
          writeToggle.finishWriteOperation(false, 'Connection failed');
          readToggle.finishWriteOperation(false, 'Connection failed');
        }
      }

      async function setupErrorToggle(toggle) {
        // Show initial loading
        toggle.startWriteOperation();
        
        // Try to connect (will fail)
        try {
          const response = await fetch('https://invalid.example/td', { 
            method: 'GET',
            mode: 'cors',
            cache: 'no-cache'
          });
          if (!response.ok) throw new Error('Network error');
          toggle.finishWriteOperation(true);
        } catch (err) {
          toggle.finishWriteOperation(false, 'Connection failed');
          toggle.connected = false;
        }

        // Add retry logic when user tries to toggle during error state
        toggle.addEventListener('valueMsg', async e => {
          const previousValue = !e.detail.payload;
          toggle.clearErrorState(); // Clear error before retry
          toggle.startWriteOperation();
          
          // Attempt to reconnect/retry (will still fail)
          try {
            const response = await fetch('https://invalid.example/td', { 
              method: 'GET',
              mode: 'cors',
              cache: 'no-cache'
            });
            if (!response.ok) throw new Error('Network error');
            // If somehow it succeeds
            toggle.finishWriteOperation(true);
          } catch (err) {
            // Still fails - show error and revert
            toggle.finishWriteOperation(false, 'Connection failed');
            toggle.revertValue(previousValue);
            toggle.connected = false;
          }
        });
      }
    </script>
  </body>
</html>
