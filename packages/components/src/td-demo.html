<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>ui-toggle</title>
    <style>
      body {
        font-family: system-ui, -apple-system, sans-serif;
        max-width: 800px;
        margin: 36px auto;
        padding: 18px;
        background: #f8fafc;
      }
      .card {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
      }
      .row {
        display: flex;
        gap: 18px;
        align-items: center;
        margin-bottom: 14px;
      }
      .meta {
        color: #6b7280;
        font-size: 13px;
      }
      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
      @keyframes pulse {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
      }
      @keyframes ping {
        75%,
        100% {
          transform: scale(1.5);
          opacity: 0;
        }
      }
    </style>
  </head>
  <body>
    <div class="card">
      <h1>ui-toggle TD demo (simplified)</h1>
      <p class="meta">Simple TD integration without legacy mode prop</p>

      <div class="row">
        <div>
          <h3>Controller (readwrite)</h3>
          <ui-toggle
            id="readwrite-toggle"
            td-property="bool"
            td-url="http://plugfest.thingweb.io/http-data-schema-thing"
            sync-interval="3000"
            label="Controller"
          ></ui-toggle>
        </div>
        <div class="meta">Property: <strong>bool</strong></div>
      </div>

      <div class="row">
        <div>
          <h3>Monitor (read-only)</h3>
          <ui-toggle id="readonly-toggle" readonly="true" sync-interval="3000" variant="square" label="Monitor"></ui-toggle>
        </div>
        <div class="meta">Property: <strong>bool</strong></div>
      </div>

      <hr style="margin: 20px 0; border: none; border-top: 1px solid #e5e7eb;">

      <div class="row">
        <div>
          <h3>Error Test (fake URL)</h3>
          <ui-toggle
            id="error-toggle"
            td-property="bool"
            td-url="http://fake-url-that-does-not-exist.com/td"
            label="Error Demo"
            variant="neon"
          ></ui-toggle>
        </div>
        <div class="meta">Should show red error badge</div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@node-wot/browser-bundle@latest/dist/wot-bundle.min.js"></script>
    <script type="module" src="./build/ui-wot-components.esm.js"></script>

    <script>
      document.addEventListener('DOMContentLoaded', async () => {
        const RW = document.getElementById('readwrite-toggle');
        const RO = document.getElementById('readonly-toggle');
        const ERROR = document.getElementById('error-toggle');

        await customElements.whenDefined('ui-toggle');

        // Setup error test toggle
        setupErrorToggle(ERROR);

        // Setup working toggles
        setupWorkingToggles(RW, RO);
      });

      async function setupErrorToggle(toggle) {
        const TD_URL = toggle.getAttribute('td-url');
        
        // Show loading
        toggle.startWriteOperation();

        try {
          // This will fail
          const res = await fetch(TD_URL);
          const td = await res.json();
          // Won't reach here
        } catch (err) {
          // Show error badge
          toggle.finishWriteOperation(false, 'Connection failed');
          toggle.connected = false;
        }
      }

      async function setupWorkingToggles(RW, RO) {
        const TD_URL = RW.getAttribute('td-url');
        
        // Show loading
        RW.startWriteOperation();
        RO.startWriteOperation();

        try {
          // Setup WoT
          while (!window.WoT) await new Promise(r => setTimeout(r, 100));
          const WoT = window.WoT;
          const servient = new WoT.Core.Servient();
          servient.addClientFactory(new WoT.Http.HttpClientFactory());
          const wot = await servient.start();

          // Fetch and consume TD
          const res = await fetch(TD_URL);
          const td = await res.json();
          const thing = await wot.consume(td);
          const prop = RW.getAttribute('td-property');

          // Setup successful
          RW.finishWriteOperation(true);
          RO.finishWriteOperation(true);

          // Read initial value
          const initial = Boolean(await (await thing.readProperty(prop)).value());
          RW.value = RO.value = initial;
          RO.markReadUpdate();

          // Simple polling
          setInterval(async () => {
            try {
              const current = Boolean(await (await thing.readProperty(prop)).value());
              RW.value = RO.value = current;
              RO.markReadUpdate();
            } catch (e) {
              RO.connected = RW.connected = false;
            }
          }, 3000);

          // Handle writes
          RW.addEventListener('valueMsg', async e => {
            RW.startWriteOperation();
            try {
              await thing.writeProperty(prop, e.detail.payload);
              RW.finishWriteOperation(true);
              RO.value = e.detail.payload;
              RO.markReadUpdate();
            } catch (err) {
              RW.finishWriteOperation(false, 'Write failed');
            }
          });

        } catch (err) {
          RW.finishWriteOperation(false, 'Connection failed');
          RO.finishWriteOperation(false, 'Connection failed');
          RW.connected = RO.connected = false;
        }
      }
    </script>
  </body>
</html>
