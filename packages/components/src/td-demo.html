<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>ui-toggle</title>
    <style>
      body {
        font-family: system-ui, -apple-system, sans-serif;
        max-width: 780px;
        margin: 32px auto;
        padding: 16px;
        background: #f8fafc;
      }
      .card {
        background: #fff;
        padding: 18px 20px;
        border-radius: 10px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
      }
      .row {
        display: flex;
        gap: 14px;
        align-items: center;
        margin: 12px 0;
      }
      .meta {
        color: #6b7280;
        font-size: 12px;
      }
    </style>
  </head>
  <body>
    <div class="card">
      <h1>Simple UI-toggle Demo</h1>
      <div class="row">
        <div>
          <h3>Controller (readwrite)</h3>
          <ui-toggle id="readwrite-toggle" td-property="bool" td-url="http://plugfest.thingweb.io/http-data-schema-thing" label="Controller" show-></ui-toggle>
        </div>
      </div>

      <div class="row">
        <div>
          <h3>Monitor (read-only)</h3>
          <ui-toggle id="readonly-toggle" readonly="true" variant="square" label="Monitor" show-last-updated show-status="false"></ui-toggle>
        </div>
      </div>

      <div class="row">
        <div>
          <h3>Error Test (false URL)</h3>
          <ui-toggle id="error-toggle" showLastUpdated="true" td-property="bool" td-url="http://fake-url-that-does-not-exist.com/td" label="Error Demo" variant="neon"></ui-toggle>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@node-wot/browser-bundle@latest/dist/wot-bundle.min.js"></script>
    <script type="module" src="./build/ui-wot-components.esm.js"></script>

    <script>
      document.addEventListener('DOMContentLoaded', async () => {
        // Get components
        const toggle = document.getElementById('readwrite-toggle');
        const toggleRO = document.getElementById('readonly-toggle');
        const errorToggle = document.getElementById('error-toggle');

        await customElements.whenDefined('ui-toggle');

        // Setup working toggles
        setupToggle(toggle, toggleRO);

        // Setup error toggle
        setupErrorToggle(errorToggle);
      });

      async function setupToggle(writeToggle, readToggle) {
        const tdUrl = writeToggle.getAttribute('td-url');
        const tdProp = writeToggle.getAttribute('td-property');

        try {
          // Wait for WoT and setup servient
          while (!window.WoT) await new Promise(r => setTimeout(r, 100));
          const servient = new window.WoT.Core.Servient();
          servient.addClientFactory(new window.WoT.Http.HttpClientFactory());
          const wot = await servient.start();

          // Consume thing
          const td = await (await fetch(tdUrl)).json();
          const thing = await wot.consume(td);

          // Read initial value
          const initial = Boolean(await (await thing.readProperty(tdProp)).value());
          await writeToggle.setValueSilent(initial);
          await readToggle.setValueSilent(initial);
          // safe polling loop to avoid overlapping reads
          (async function pollLoop() {
            while (true) {
              try {
                const current = Boolean(await (await thing.readProperty(tdProp)).value());
                if (typeof readToggle.setValueSilent === 'function') await readToggle.setValueSilent(current);
                if (typeof readToggle.triggerReadPulse === 'function') await readToggle.triggerReadPulse();
              } catch (e) {
                readToggle.connected = false;
              }
              await new Promise(r => setTimeout(r, 2000));
            }
          })();

          writeToggle.addEventListener('valueMsg', async e => {
            e.stopPropagation();

            const targetValue = e.detail.payload;
            console.log('User clicked toggle, attempting to write:', targetValue);

            try {
              await writeToggle.setStatus('loading');
              await thing.writeProperty(tdProp, targetValue);
              await writeToggle.setStatus('success');

              console.log('Write successful:', targetValue);
            } catch (err) {
              console.log('Write failed:', err.message);

              // Error - show error and revert
              await writeToggle.setStatus('error', 'Write failed: ' + err.message);
              await writeToggle.setValueSilent(!targetValue);
            }
          });
        } catch (err) {
          // Show connection error on both toggles
          await writeToggle.setStatus('error', 'Connection failed: ' + err.message);
          await readToggle.setStatus('error', 'Connection failed: ' + err.message);
        }
      }

      async function setupErrorToggle(toggle) {
        // Set initial error state to demonstrate error handling
        await toggle.setStatus('error', 'Connection failed');
        toggle.connected = false;

        toggle.addEventListener('valueMsg', async e => {
          e.stopPropagation();

          const targetValue = e.detail.payload;
          console.log('User clicked error toggle, attempting retry:', targetValue);

          try {
            // Clear error state and show loading
            await toggle.setStatus('loading');
            toggle.connected = true;
            const response = await fetch('https://invalid.example/td');
            if (!response.ok) throw new Error('Connection failed');
            await toggle.setStatus('success');
          } catch (error) {
            console.log('Retry failed:', error.message);
            await toggle.setStatus('error', 'Still unable to connect: ' + error.message);
            toggle.connected = false;
            await toggle.setValueSilent(!targetValue);
          }
        });
      }
    </script>
  </body>
</html>
