<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>UI-Toggle TD Integration Demo</title>
  <style>
    body {
      font-family: system-ui, -apple-system, sans-serif;
      max-width: 800px;
      margin: 40px auto;
      padding: 20px;
      background: #f9fafb;
    }
    .demo-container {
      background: white;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .toggle-section {
      margin-bottom: 30px;
      padding: 20px;
      background: #f8fafc;
      border-radius: 8px;
      border-left: 4px solid #0ea5e9;
    }
    .status {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 14px;
      margin-bottom: 20px;
    }
    .status.connecting { background: #fef3c7; color: #92400e; }
    .status.connected { background: #d1fae5; color: #065f46; }
    .status.error { background: #fee2e2; color: #991b1b; }
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }
    .connecting .status-dot { background: #f59e0b; }
    .connected .status-dot { background: #10b981; }
    .error .status-dot { background: #ef4444; }
    .info {
      font-size: 14px;
      color: #6b7280;
      margin-top: 10px;
    }
    h1 { color: #1f2937; margin-bottom: 10px; }
    h2 { color: #374151; margin-bottom: 15px; font-size: 18px; }
    p { color: #6b7280; margin-bottom: 20px; }
  </style>
</head>
<body>
  <div class="demo-container">
    <h1>UI-Toggle Thing Description Demo</h1>
    <p>Minimal demonstration of ui-toggle components connected to a Thing Description</p>

    <!-- Connection Status -->
    <div id="connection-status" class="status connecting" style="display: none;">
      <div class="status-dot"></div>
      <span id="status-text">Connecting...</span>
    </div>

  <!-- Read-Write Toggle -->
    <div class="toggle-section">
      <h2>Read-Write Mode</h2>
      <ui-toggle 
        id="readwrite-toggle" 
    mode="readwrite" 
    td-property="bool"
    td-url="http://plugfest.thingweb.io/http-data-schema-thing"
    auto-sync="3000"
    write-on="auto"
    short-label="RW"
        variant="neon" 
        color="primary" 
        label="Boolean Property Control">
      </ui-toggle>
      <div class="info">
        <strong>Property:</strong> bool | 
        <span id="rw-value">Value: -</span> | 
        <span id="rw-update">Last update: -</span>
      </div>
    </div>

  <!-- Read-Only Toggle -->
    <div class="toggle-section">
      <h2>Read-Only Mode</h2>
      <ui-toggle 
        id="readonly-toggle" 
    mode="read" 
    td-property="bool"
    auto-sync="3000"
    write-on="none"
    mirror="#readwrite-toggle"
        variant="square" 
        color="secondary" 
        label="Boolean Property Monitor">
      </ui-toggle>
      <div class="info">
        <strong>Property:</strong> bool | 
        <span id="ro-value">Value: -</span> | 
        <span id="ro-update">Last update: -</span>
      </div>
    </div>
  </div>

  <!-- Load WoT Bundle -->
  <script src="https://cdn.jsdelivr.net/npm/@node-wot/browser-bundle@latest/dist/wot-bundle.min.js"></script>
  
  <!-- Load UI Components -->
  <script type="module" src="./build/ui-wot-components.esm.js"></script>

  <script>
    // Configuration
    const TD_URL = 'http://plugfest.thingweb.io/http-data-schema-thing';
    
    // UI Elements
    const statusEl = document.getElementById('connection-status');
    const statusText = document.getElementById('status-text');
    const rwToggle = document.getElementById('readwrite-toggle');
    const roToggle = document.getElementById('readonly-toggle');
    const rwValue = document.getElementById('rw-value');
    const rwUpdate = document.getElementById('rw-update');
    const roValue = document.getElementById('ro-value');
    const roUpdate = document.getElementById('ro-update');

    // Global variables
    let currentThing = null;

    // Helper functions
    function setStatus(type, message) {
      statusEl.className = `status ${type}`;
      statusEl.style.display = 'block';
      statusText.textContent = message;
    }

    function updateValue(valueEl, updateEl, value) {
      valueEl.textContent = `Value: ${value}`;
      updateEl.textContent = `Last update: ${new Date().toLocaleTimeString()}`;
    }

    // Main integration function
    async function initTD() {
      try {
        setStatus('connecting', 'Initializing WoT...');
        
        // Wait for WoT bundle
        while (!window.WoT) {
          await new Promise(resolve => setTimeout(resolve, 100));
        }

        // Create servient and start WoT
        const servient = new window.WoT.Core.Servient();
        servient.addClientFactory(new window.WoT.Http.HttpClientFactory());
        const wot = await servient.start();

        setStatus('connecting', 'Fetching Thing Description...');
        
        // Fetch TD
        const response = await fetch(TD_URL);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        
        const td = await response.json();
        currentThing = await wot.consume(td);
        
        setStatus('connected', 'Connected to TD');
        
        // Setup boolean property integration
        await setupBooleanProperty();
        
      } catch (error) {
        console.error('TD integration failed:', error);
        setStatus('error', `Failed: ${error.message}`);
      }
    }

    async function setupBooleanProperty() {
      const propertyName = 'bool';
      
      try {
        // Initial read
        const initialValue = await currentThing.readProperty(propertyName);
        const boolValue = Boolean(await initialValue.value());
        
        // Update both components
        rwToggle.value = boolValue;
        roToggle.value = boolValue;
        updateValue(rwValue, rwUpdate, boolValue);
        updateValue(roValue, roUpdate, boolValue);
        
        console.log('Initial value:', boolValue);
        
        // Setup observation or polling
        try {
          await currentThing.observeProperty(propertyName, async (data) => {
            const newValue = Boolean(await data.value());
            console.log('Observed change:', newValue);
            
            // Update both toggles
            rwToggle.value = newValue;
            roToggle.value = newValue;
            updateValue(rwValue, rwUpdate, newValue);
            updateValue(roValue, roUpdate, newValue);
          });
          
          console.log('Observation setup successful');
        } catch (obsError) {
          console.warn('Observation failed, using polling:', obsError.message);
          
          // Fallback polling every 3 seconds
          setInterval(async () => {
            try {http://localhost:3333/td-demo.html
              const currentValue = await currentThing.readProperty(propertyName);
              const boolValue = Boolean(await currentValue.value());
              
              if (rwToggle.value !== boolValue) {
                rwToggle.value = boolValue;
                roToggle.value = boolValue;
                updateValue(rwValue, rwUpdate, boolValue);
                updateValue(roValue, roUpdate, boolValue);
                console.log('Polled change:', boolValue);
              }
            } catch (pollError) {
              console.warn('Polling error:', pollError.message);
            }
          }, 3000);
        }
        
        // Handle writes from read-write toggle
        rwToggle.addEventListener('valueChange', async (event) => {
          try {
            const newValue = Boolean(event.detail.value);
            console.log('Writing value:', newValue);
            
            await currentThing.writeProperty(propertyName, newValue);
            
            // Update displays
            updateValue(rwValue, rwUpdate, newValue);
            updateValue(roValue, roUpdate, newValue);
            
            // Sync read-only toggle
            roToggle.value = newValue;
            
            console.log('Write successful:', newValue);
          } catch (writeError) {
            console.error('Write error:', writeError.message);
            // Revert on error
            const revertValue = await currentThing.readProperty(propertyName);
            rwToggle.value = Boolean(await revertValue.value());
          }
        });
        
      } catch (error) {
        console.error('Property setup error:', error.message);
      }
    }

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', () => {
      // Small delay to ensure components are loaded
      setTimeout(initTD, 500);
    });
  </script>
</body>
</html>
