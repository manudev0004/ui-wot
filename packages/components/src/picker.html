<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Calendar, File Picker & Color Picker TD Demo</title>
    <style>
      body {
        font-family: system-ui, -apple-system, sans-serif;
        max-width: 1200px;
        margin: 28px auto;
        padding: 18px;
        background: #f8fafc;
      }
      .card {
        background: #fff;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
        margin-bottom: 24px;
      }
      .row {
        display: flex;
        gap: 20px;
        align-items: flex-start;
        margin: 20px 0;
      }
      .column {
        flex: 1;
      }
      h1 {
        margin: 0 0 16px;
        color: #1f2937;
        text-align: center;
      }
      h2 {
        margin: 0 0 16px;
        color: #374151;
        border-bottom: 2px solid #e5e7eb;
        padding-bottom: 8px;
      }
      h3 {
        margin: 16px 0 12px;
        color: #4b5563;
      }
      .meta {
        color: #6b7280;
        font-size: 13px;
        margin-bottom: 16px;
      }
      .status {
        padding: 12px 16px;
        border-radius: 8px;
        font-size: 14px;
        margin: 12px 0;
        font-weight: 500;
      }
      .status.connected {
        background: #dcfce7;
        color: #166534;
        border: 1px solid #bbf7d0;
      }
      .status.disconnected {
        background: #fee2e2;
        color: #991b1b;
        border: 1px solid #fecaca;
      }
      .status.connecting {
        background: #fef3c7;
        color: #92400e;
        border: 1px solid #fed7aa;
      }
      .grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 24px;
      }
      .property-info {
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        padding: 12px;
        margin: 8px 0;
        font-size: 12px;
        color: #4b5563;
      }
      .button-group {
        display: flex;
        gap: 12px;
        margin: 16px 0;
      }
      .test-button {
        padding: 8px 16px;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
      }
      .test-button.primary {
        background: #3b82f6;
        color: white;
      }
      .test-button.primary:hover {
        background: #2563eb;
      }
      .test-button.secondary {
        background: #6b7280;
        color: white;
      }
      .test-button.secondary:hover {
        background: #4b5563;
      }
    </style>
  </head>
  <body>
    <h1>Calendar, File Picker & Color Picker TD Integration Demo</h1>
    
    <div id="connection-status" class="status disconnected">Disconnected - Loading...</div>

    <div class="grid">
      <!-- Left Column: Calendar Components -->
      <div class="card">
        <h2>üìÖ Calendar Components</h2>
        <p class="meta">Date, time, and datetime pickers connected to TestThing TD properties</p>

        <div class="column">
          <h3>Current Date</h3>
          <div class="property-info">
            Connected to TD property: <code>currentDate</code> (date format)
          </div>
          <ui-calendar
            id="td-calendar-date"
            label="Current Date"
            variant="outlined"
            color="primary"
            show-last-updated="true"
            show-status="true"
          ></ui-calendar>

          <h3>Current Time</h3>
          <div class="property-info">
            Connected to TD property: <code>currentTime</code> (time format)
          </div>
          <ui-calendar
            id="td-calendar-time"
            label="Current Time"
            variant="outlined"
            color="secondary"
            include-time="true"
            time-format="24"
            show-last-updated="true"
            show-status="true"
          ></ui-calendar>

          <h3>Current DateTime</h3>
          <div class="property-info">
            Connected to TD property: <code>currentDateTime</code> (datetime format)
          </div>
          <ui-calendar
            id="td-calendar-datetime"
            label="Current DateTime"
            variant="filled"
            color="primary"
            include-time="true"
            time-format="24"
            show-last-updated="true"
            show-status="true"
          ></ui-calendar>
        </div>
      </div>

      <!-- Right Column: Color & File Picker Components -->
      <div class="card">
        <h2>üé® Color Picker Components</h2>
        <p class="meta">Color pickers connected to different color property formats</p>

        <div class="column">
          <h3>Hex Color</h3>
          <div class="property-info">
            Connected to TD property: <code>currentColor</code> (hex string)
          </div>
          <ui-color-picker
            id="td-color-hex"
            label="Current Color (Hex)"
            variant="outlined"
            color="primary"
            show-last-updated="true"
            show-status="true"
          ></ui-color-picker>

          <h3>RGB Color</h3>
          <div class="property-info">
            Connected to TD property: <code>colorRgb</code> (RGB object)
          </div>
          <ui-color-picker
            id="td-color-rgb"
            label="RGB Color"
            variant="filled"
            color="secondary"
            show-last-updated="true"
            show-status="true"
          ></ui-color-picker>
        </div>

        <h2>üìÅ File Picker Components</h2>
        <p class="meta">File pickers connected to file metadata properties and upload actions</p>

        <div class="column">
          <h3>Single File Selection</h3>
          <div class="property-info">
            Connected to TD property: <code>selectedFile</code> + action: <code>upload-file</code>
          </div>
          <ui-file-picker
            id="td-file-single"
            label="Single File Upload"
            variant="outlined"
            color="primary"
            accept=".txt,.json,.md"
            max-file-size="1048576"
            show-last-updated="true"
            show-status="true"
          ></ui-file-picker>

          <h3>Multiple File Selection</h3>
          <div class="property-info">
            Connected to TD property: <code>fileList</code> + action: <code>upload-file</code>
          </div>
          <ui-file-picker
            id="td-file-multiple"
            label="Multiple File Upload"
            variant="filled"
            color="secondary"
            multiple="true"
            accept="image/*,.pdf"
            max-file-size="5242880"
            show-last-updated="true"
            show-status="true"
          ></ui-file-picker>
        </div>
      </div>
    </div>

    <!-- Testing Controls -->
    <div class="card">
      <h2>üß™ Testing Controls</h2>
      <div class="button-group">
        <button id="test-read-all" class="test-button primary">Read All Properties</button>
        <button id="test-set-defaults" class="test-button secondary">Set Default Values</button>
        <button id="clear-all-files" class="test-button secondary">Clear All Files</button>
        <button id="convert-color" class="test-button secondary">Convert Color Formats</button>
      </div>
      
      <div class="meta">
        <strong>TD URL:</strong> http://localhost:8080/testthing<br>
        <strong>Available Properties:</strong> currentDate, currentTime, currentDateTime, currentColor, colorRgb, colorHsl, selectedFile, fileList<br>
        <strong>Available Actions:</strong> upload-file, clear-files, convert-color, set-date-range<br>
        Open browser console to see detailed TD interaction logs.
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@node-wot/browser-bundle@latest/dist/wot-bundle.min.js"></script>
    <script type="module" src="./build/ui-wot-components.esm.js"></script>

    <script>
      // Global variables for TD integration
      let sharedWoTInstance = null;
      let sharedThingInstance = null;

      document.addEventListener('DOMContentLoaded', async () => {
        // Wait for all components to be defined
        const COMPONENT_TAGS = ['ui-calendar', 'ui-color-picker', 'ui-file-picker'];
        await Promise.all(COMPONENT_TAGS.map(tag => customElements.whenDefined(tag)));
        console.log('All components ready for TD integration');

        // Get status element
        const statusElement = document.getElementById('connection-status');

        // Initialize WoT and connect to TestThing
        try {
          statusElement.textContent = 'Connecting to TestThing...';
          statusElement.className = 'status connecting';

          // Wait for WoT library
          if (!window.WoT) {
            throw new Error('WoT library not loaded');
          }

          // Create WoT servient instance
          console.log('Creating WoT servient...');
          const servient = new window.WoT.Core.Servient();
          servient.addClientFactory(new window.WoT.Http.HttpClientFactory());
          sharedWoTInstance = await servient.start();
          console.log('WoT servient started successfully');

          // Fetch and consume TestThing TD
          const tdUrl = 'http://localhost:8080/testthing';
          console.log('Fetching TD from:', tdUrl);

          const response = await fetch(tdUrl);
          const tdJson = await response.json();
          sharedThingInstance = await sharedWoTInstance.consume(tdJson);
          console.log('TestThing TD consumed successfully');
          
          // Log available properties and actions
          console.log('Available properties:', Object.keys(tdJson.properties || {}));
          console.log('Available actions:', Object.keys(tdJson.actions || {}));
          console.log('Available events:', Object.keys(tdJson.events || {}));

          statusElement.textContent = 'Connected to TestThing';
          statusElement.className = 'status connected';

          // Test connection with a simple read
          try {
            await sharedThingInstance.readProperty('currentDate');
            console.log('Connection test passed');
          } catch (testError) {
            console.warn('Connection test failed:', testError);
          }

          // Initialize all components
          await initializeCalendarComponents();
          await initializeColorPickerComponents();
          await initializeFilePickerComponents();
          await setupTestingControls();

        } catch (error) {
          console.error('WoT initialization failed:', error);
          statusElement.textContent = `Connection failed: ${error.message}`;
          statusElement.className = 'status disconnected';

          // Show user-friendly error
          document.body.insertAdjacentHTML(
            'beforeend',
            `
            <div style="background: #fee2e2; border: 1px solid #fecaca; border-radius: 8px; padding: 16px; margin: 16px auto; max-width: 1200px; color: #991b1b;">
              <strong>Connection Failed</strong><br>
              Could not connect to TestThing at localhost:8080. Please ensure:<br>
              ‚Ä¢ TestThing server is running on localhost:8080<br>
              ‚Ä¢ CORS is enabled for browser requests<br>
              ‚Ä¢ Network connectivity is available<br>
              <em>Error: ${error.message}</em>
            </div>
          `,
          );
        }

        // Helper function to safely convert RGB to hex
        function rgbToHex(rgb) {
          if (!rgb || typeof rgb !== 'object') return '#000000';
          const r = Math.max(0, Math.min(255, rgb.r || 0));
          const g = Math.max(0, Math.min(255, rgb.g || 0));
          const b = Math.max(0, Math.min(255, rgb.b || 0));
          return '#' + [r, g, b].map(x => x.toString(16).padStart(2, '0')).join('');
        }

        // Helper function to convert hex to RGB
        function hexToRgb(hex) {
          const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
          return result ? {
            r: parseInt(result[1], 16),
            g: parseInt(result[2], 16),
            b: parseInt(result[3], 16)
          } : { r: 0, g: 0, b: 0 };
        }

        // Initialize Calendar Components
        async function initializeCalendarComponents() {
          if (!sharedThingInstance) return;
          console.log('Initializing calendar components...');

          // Date Calendar - connects to currentDate property
          const dateCalendar = document.getElementById('td-calendar-date');
          if (dateCalendar) {
            await dateCalendar.componentOnReady();
            
            // Set up write operation only - let calendar fetch TD value when user interacts
            await dateCalendar.setWriteOperation(async (newValue) => {
              console.log('Writing date value:', newValue, 'to currentDate property');
              // Extract just the date part for the TD property
              const dateOnly = new Date(newValue).toISOString().split('T')[0];
              await sharedThingInstance.writeProperty('currentDate', dateOnly);
              console.log('Date write successful:', dateOnly);
            });
            
            console.log('Date calendar connected - ready for user interaction');
          }

          // Time Calendar - connects to currentTime property
          const timeCalendar = document.getElementById('td-calendar-time');
          if (timeCalendar) {
            await timeCalendar.componentOnReady();
            
            // Set up write operation only - let calendar fetch TD value when user interacts
            await timeCalendar.setWriteOperation(async (newValue) => {
              console.log('Writing time value:', newValue, 'to currentTime property');
              // Extract just the time part for the TD property
              const timeOnly = new Date(newValue).toTimeString().split(' ')[0];
              await sharedThingInstance.writeProperty('currentTime', timeOnly);
              console.log('Time write successful:', timeOnly);
            });
            
            console.log('Time calendar connected - ready for user interaction');
          }

          // DateTime Calendar - connects to currentDateTime property
          const datetimeCalendar = document.getElementById('td-calendar-datetime');
          if (datetimeCalendar) {
            await datetimeCalendar.componentOnReady();
            
            // Set up write operation only - let calendar fetch TD value when user interacts
            await datetimeCalendar.setWriteOperation(async (newValue) => {
              console.log('Writing datetime value:', newValue, 'to currentDateTime property');
              await sharedThingInstance.writeProperty('currentDateTime', newValue);
              console.log('DateTime write successful');
            });
            
            console.log('DateTime calendar connected - ready for user interaction');
          }
        }

        // Initialize Color Picker Components
        async function initializeColorPickerComponents() {
          if (!sharedThingInstance) return;
          console.log('Initializing color picker components...');

          // Hex Color Picker - connects to currentColor property
          const hexColorPicker = document.getElementById('td-color-hex');
          if (hexColorPicker) {
            await hexColorPicker.componentOnReady();
            
            try {
              const propertyValue = await sharedThingInstance.readProperty('currentColor');
              let value = await propertyValue.value();
              
              // Ensure hex color format
              const hexValue = (typeof value === 'string' && value.startsWith('#')) ? value : '#3b82f6';
              
              await hexColorPicker.setValue(hexValue, {
                writeOperation: async (newValue) => {
                  console.log('Writing hex color value:', newValue, 'to currentColor property');
                  await sharedThingInstance.writeProperty('currentColor', newValue);
                  console.log('Hex color write successful');
                }
              });
              
              console.log('Hex color picker connected, initial value:', hexValue);
            } catch (error) {
              console.error('Hex color picker connection failed:', error);
              await hexColorPicker.setValue('#3b82f6');
              console.error('Hex color picker error:', error);
            }
          }

          // RGB Color Picker - connects to colorRgb property
          const rgbColorPicker = document.getElementById('td-color-rgb');
          if (rgbColorPicker) {
            await rgbColorPicker.componentOnReady();
            
            try {
              const propertyValue = await sharedThingInstance.readProperty('colorRgb');
              let value = await propertyValue.value();
              
              // Convert RGB object to hex for color picker
              const hexValue = rgbToHex(value);
              
              await rgbColorPicker.setValue(hexValue, {
                writeOperation: async (newValue) => {
                  console.log('Writing RGB color value:', newValue, 'to colorRgb property');
                  
                  // Convert hex back to RGB object for TD
                  const rgbValue = hexToRgb(newValue);
                  await sharedThingInstance.writeProperty('colorRgb', rgbValue);
                  console.log('RGB color write successful:', rgbValue);
                }
              });
              
              console.log('RGB color picker connected, initial value:', hexValue, 'from RGB:', value);
            } catch (error) {
              console.error('RGB color picker connection failed:', error);
              await rgbColorPicker.setValue('#10b981');
              console.error('RGB color picker error:', error);
            }
          }
        }

        // Initialize File Picker Components
        async function initializeFilePickerComponents() {
          if (!sharedThingInstance) return;
          console.log('Initializing file picker components...');

          // Single File Picker - connects to selectedFile property and upload-file action
          const singleFilePicker = document.getElementById('td-file-single');
          if (singleFilePicker) {
            await singleFilePicker.componentOnReady();
            
            await singleFilePicker.setUpload(async (files) => {
              console.log('Uploading single file to TD:', files.map(f => f.name));
              
              if (files.length > 0) {
                const file = files[0];
                
                // Create file metadata object for TD
                const fileMetadata = {
                  name: file.name,
                  size: file.size,
                  type: file.type,
                  lastModified: file.lastModified
                };
                
                try {
                  // Update selectedFile property
                  await sharedThingInstance.writeProperty('selectedFile', fileMetadata);
                  console.log('Selected file property updated:', fileMetadata);
                  
                  // Convert file content to base64 for upload action
                  const reader = new FileReader();
                  const base64Content = await new Promise((resolve, reject) => {
                    reader.onload = () => resolve(reader.result.split(',')[1]);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                  });
                  
                  // Invoke upload-file action
                  const uploadPayload = {
                    name: file.name,
                    size: file.size,
                    type: file.type,
                    content: base64Content
                  };
                  
                  const uploadResult = await sharedThingInstance.invokeAction('upload-file', uploadPayload);
                  const result = await uploadResult.value();
                  console.log('Single file upload successful:', result);
                  
                } catch (error) {
                  console.error('Single file upload failed:', error);
                  throw error;
                }
              }
            });
            
            console.log('Single file picker connected to selectedFile property and upload-file action');
          }

          // Multiple File Picker - connects to fileList property and upload-file action
          const multipleFilePicker = document.getElementById('td-file-multiple');
          if (multipleFilePicker) {
            await multipleFilePicker.componentOnReady();
            
            await multipleFilePicker.setUpload(async (files) => {
              console.log('Uploading multiple files to TD:', files.map(f => f.name));
              
              // Create file list metadata for TD
              const fileListMetadata = files.map(file => ({
                name: file.name,
                size: file.size,
                type: file.type,
                lastModified: file.lastModified
              }));
              
              try {
                // Update fileList property
                await sharedThingInstance.writeProperty('fileList', fileListMetadata);
                console.log('File list property updated:', fileListMetadata);
                
                // Upload each file using upload-file action
                const uploadResults = [];
                for (const file of files) {
                  const reader = new FileReader();
                  const base64Content = await new Promise((resolve, reject) => {
                    reader.onload = () => resolve(reader.result.split(',')[1]);
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                  });
                  
                  const uploadPayload = {
                    name: file.name,
                    size: file.size,
                    type: file.type,
                    content: base64Content
                  };
                  
                  const uploadResult = await sharedThingInstance.invokeAction('upload-file', uploadPayload);
                  const result = await uploadResult.value();
                  uploadResults.push(result);
                }
                
                console.log('Multiple file upload successful:', uploadResults);
                
              } catch (error) {
                console.error('Multiple file upload failed:', error);
                throw error;
              }
            });
            
            console.log('Multiple file picker connected to fileList property and upload-file action');
          }
        }

        // Setup Testing Controls
        async function setupTestingControls() {
          if (!sharedThingInstance) return;

          // Read All Properties
          document.getElementById('test-read-all').addEventListener('click', async () => {
            console.log('=== Reading All Properties ===');
            try {
              const properties = ['currentDate', 'currentTime', 'currentDateTime', 'currentColor', 'colorRgb', 'selectedFile', 'fileList'];
              for (const prop of properties) {
                try {
                  const value = await (await sharedThingInstance.readProperty(prop)).value();
                  console.log(`${prop}:`, value);
                } catch (error) {
                  console.error(`Failed to read ${prop}:`, error.message);
                }
              }
            } catch (error) {
              console.error('Failed to read properties:', error);
            }
          });

          // Set Default Values
          document.getElementById('test-set-defaults').addEventListener('click', async () => {
            console.log('=== Setting Default Values ===');
            try {
              const now = new Date();
              await sharedThingInstance.writeProperty('currentDate', now.toISOString().split('T')[0]);
              await sharedThingInstance.writeProperty('currentTime', now.toTimeString().split(' ')[0]);
              await sharedThingInstance.writeProperty('currentDateTime', now.toISOString());
              await sharedThingInstance.writeProperty('currentColor', '#3b82f6');
              await sharedThingInstance.writeProperty('colorRgb', { r: 59, g: 130, b: 246 });
              console.log('Default values set successfully');
            } catch (error) {
              console.error('Failed to set defaults:', error);
            }
          });

          // Clear All Files
          document.getElementById('clear-all-files').addEventListener('click', async () => {
            console.log('=== Clearing All Files ===');
            try {
              await sharedThingInstance.invokeAction('clear-files');
              await sharedThingInstance.writeProperty('selectedFile', null);
              await sharedThingInstance.writeProperty('fileList', []);
              console.log('Files cleared successfully');
            } catch (error) {
              console.error('Failed to clear files:', error);
            }
          });

          // Convert Color Formats
          document.getElementById('convert-color').addEventListener('click', async () => {
            console.log('=== Converting Color Formats ===');
            try {
              const conversionParams = {
                color: '#ff5722',
                from: 'hex',
                to: 'rgb'
              };
              const result = await sharedThingInstance.invokeAction('convert-color', conversionParams);
              const convertedColor = await result.value();
              console.log('Color conversion result:', convertedColor);
            } catch (error) {
              console.error('Failed to convert color:', error);
            }
          });
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
          console.log('Cleaning up WoT connections...');
          if (sharedWoTInstance) {
            // Cleanup any subscriptions if needed
          }
        });
      });
    </script>
  </body>
</html>